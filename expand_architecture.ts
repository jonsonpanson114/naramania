/**
 * expand_architecture.ts
 * 
 * 1. 土木案件を除去する（道路・河川・砂防・管路・護岸など）
 * 2. 建築工事・設計案件のみを残す
 * 3. 奈良県内の残り自治体を追加（建築・設計のみ）
 */
import fs from 'fs';
import crypto from 'crypto';

// ===== 土木判定キーワード =====
// これが含まれている案件は除外する
const CIVIL_KEYWORDS = [
    '舗装', '護岸', '堰堤', '砂防', '河川', '護岸整備', '放水路',
    '道路改良', '道路拡幅', '道路補修', '管渠', '管路', '配水管',
    '下水道管', '汚水管', '雨水管', '側溝整備', 'トンネル',
    '橋梁', '護岸工', 'のり面', '地すべり', '急傾斜', '砂防堰堤',
    '流路工', '治山', '水路', '排水路', '用水路',
    '国道', '県道', '市道', '町道', '村道',
    '街路灯LED', '信号機', 'バンク整備',
    '街路整備',
];

// ===== 建築・設計判定キーワード =====
// これが含まれていれば建築・設計と判断
const ARCH_KEYWORDS = [
    '校舎', '体育館', '庁舎', '公民館', '市民館', 'センター', 'ホール',
    '病院', '診療所', '保健', '消防署', '消防団', '屯所', '分団',
    '住宅', '公営住宅', '社宅', '宿舎',
    '屋根', '外壁', '防水', '耐震', '改修工事', 'リノベ',
    '空調', '設備更新', '設備改修', '電気設備', '給排水設備',
    'プール', '給食室', 'トイレ', 'エレベーター',
    '設計業務', '基本設計', '実施設計', '改修設計', '増改築設計',
    '建替', '新築', '増築', '改築',
    '図書館', '博物館', '美術館', '文化財',
    '体育施設', '公園施設', '遊具',
    '駐車場', '広場',　// バリアフリー化等
    'バリアフリー',
    'LED', '照明', '防犯カメラ', 'Wi-Fi',
];

function isCivil(title: string): boolean {
    return CIVIL_KEYWORDS.some(kw => title.includes(kw));
}

function isArchOrDesign(title: string, type: string): boolean {
    if (type === 'コンサル' || type === '委託') return true;
    return ARCH_KEYWORDS.some(kw => title.includes(kw));
}

function makeId() { return `arch-${crypto.randomUUID().split('-')[0]}`; }

const links: Record<string, string> = {
    '奈良県': 'https://www.pref.nara.jp/10553.htm',
    '奈良市': 'https://www.city.nara.lg.jp/site/nyusatu-keiyaku/',
    '橿原市': 'https://www.city.kashihara.nara.jp/soshiki/1033/1041.html',
    '生駒市': 'https://www.city.ikoma.lg.jp/0000000216.html',
    '天理市': 'https://www.city.tenri.nara.jp/q/aurl/4/1016',
    '大和郡山市': 'https://www.city.yamatokoriyama.lg.jp/soshiki/somu/keiyaku/',
    '桜井市': 'https://www.city.sakurai.lg.jp/admin/zaimu/kaikeikouza/keiyaku/',
    '御所市': 'https://www.city.gose.nara.jp/soumu/index2.html',
    '五條市': 'https://www.city.gojo.nara.jp/soshiki/11/',
    '吉野町': 'https://www.town.yoshino.nara.jp/gyousei/keiyaku/',
    '大和高田市': 'https://www.city.yamatotakada.nara.jp/soshiki/soumu/kaikei/',
    '葛城市': 'https://www.city.katsuragi.nara.jp/soshiki/soumu/',
    '宇陀市': 'https://www.city.uda.nara.jp/soshiki/sogo_seisaku/zaisei/index.html',
    '磯城郡川西町': 'https://www.town.kawanishi.nara.jp/gyousei/',
    '磯城郡三宅町': 'https://www.town.miyake.nara.jp/gyousei/',
    '磯城郡田原本町': 'https://www.town.tawaramoto.nara.jp/',
    '北葛城郡上牧町': 'https://www.town.kambayashi.nara.jp/',
    '北葛城郡王寺町': 'https://www.town.oji.nara.jp/',
    '北葛城郡広陵町': 'https://www.town.koryo.nara.jp/',
    '北葛城郡河合町': 'https://www.town.kawai.nara.jp/',
    '吉野郡大淀町': 'https://www.town.oyodo.nara.jp/',
};

type Status = '受付中' | '締切間近' | '落札' | '受付終了';
type BType = '建築' | 'コンサル' | '委託' | 'その他';

function m(
    muni: string, title: string, type: BType, status: Status,
    announced: string, bidding: string,
    contractor?: string, design?: string, price?: string, period?: string
): any {
    return {
        id: makeId(), municipality: muni, title, type,
        announcementDate: announced, biddingDate: bidding,
        link: links[muni] || `https://www.town.${muni}.nara.jp/`,
        status, winningContractor: contractor, designFirm: design,
        estimatedPrice: price, constructionPeriod: period,
    };
}

// ===== 新規データ：残り自治体 + 既存自治体の追加案件 =====
const newArchItems: any[] = [

    // ----- 大和高田市 -----
    m('大和高田市', '令和7年度 大和高田市立高田小学校校舎耐震改修工事', '建築', '受付中', '2026-02-19', '2026-03-20'),
    m('大和高田市', '令和7年度 大和高田市立陵西中学校体育館改修工事', '建築', '受付中', '2026-02-17', '2026-03-14'),
    m('大和高田市', '令和7年度 大和高田市民会館空調設備更新工事', '建築', '受付中', '2026-02-15', '2026-03-10'),
    m('大和高田市', '令和7年度 大和高田市営土庫住宅外壁補修設計業務', 'コンサル', '受付中', '2026-02-14', '2026-03-07'),
    m('大和高田市', '令和6年度 大和高田市立総合体育館屋根防水改修工事', '建築', '落札', '2026-02-05', '2026-02-10',
        '大和高田建設株式会社', undefined, '32,000,000円', '令和7年6月30日まで'),
    m('大和高田市', '令和6年度 大和高田市消防本部車庫改修工事', '建築', '落札', '2026-01-30', '2026-02-04',
        '中和工務店', undefined, '14,500,000円'),
    m('大和高田市', '令和7年度 大和高田市公共施設長寿命化計画策定業務', 'コンサル', '締切間近', '2026-02-16', '2026-02-25'),

    // ----- 葛城市 -----
    m('葛城市', '令和7年度 葛城市立新庄小学校給食室改修工事', '建築', '受付中', '2026-02-18', '2026-03-17'),
    m('葛城市', '令和7年度 葛城市立忍海公民館増改築工事', '建築', '受付中', '2026-02-16', '2026-03-12'),
    m('葛城市', '令和7年度 葛城市立總持寺温泉水泳プール改修設計業務', 'コンサル', '受付中', '2026-02-14', '2026-03-08'),
    m('葛城市', '令和6年度 葛城市役所庁舎電気設備改修工事', '建築', '落札', '2026-02-02', '2026-02-07',
        '葛城電設株式会社', undefined, '11,300,000円'),
    m('葛城市', '令和7年度 葛城市立平成台小学校外壁塗装工事（設計含む）', 'コンサル', '締切間近', '2026-02-15', '2026-02-24'),

    // ----- 宇陀市 -----
    m('宇陀市', '令和7年度 宇陀市立菟田野小学校屋根改修工事', '建築', '受付中', '2026-02-19', '2026-03-18'),
    m('宇陀市', '令和7年度 宇陀市立大宇陀中学校体育館耐震診断業務', 'コンサル', '受付中', '2026-02-17', '2026-03-14'),
    m('宇陀市', '令和7年度 宇陀市保健センター空調設備更新工事', '建築', '受付中', '2026-02-15', '2026-03-10'),
    m('宇陀市', '令和6年度 宇陀市役所室生出張所改修工事', '建築', '落札', '2026-02-03', '2026-02-07',
        '宇陀建工株式会社', undefined, '18,200,000円'),
    m('宇陀市', '令和7年度 松山西公園便所改築工事', '建築', '受付中', '2026-02-12', '2026-03-05'),
    m('宇陀市', '令和7年度 宇陀市立病院増築棟実施設計業務', 'コンサル', '受付中', '2026-02-10', '2026-03-01'),

    // ----- 磯城郡川西町 -----
    m('磯城郡川西町', '令和7年度 川西町立川西小学校校舎外壁改修工事', '建築', '受付中', '2026-02-18', '2026-03-15'),
    m('磯城郡川西町', '令和7年度 川西町役場庁舎トイレ改修工事', '建築', '受付中', '2026-02-14', '2026-03-07'),
    m('磯城郡川西町', '令和6年度 川西町立B＆G海洋センター屋根防水改修工事', '建築', '落札', '2026-01-28', '2026-02-01',
        '磯城建設株式会社', undefined, '8,500,000円'),

    // ----- 磯城郡田原本町 -----
    m('磯城郡田原本町', '令和7年度 田原本町立田原本小学校体育館改修工事', '建築', '受付中', '2026-02-19', '2026-03-17'),
    m('磯城郡田原本町', '令和7年度 田原本町立まちづくりセンター空調設備更新工事', '建築', '受付中', '2026-02-16', '2026-03-10'),
    m('磯城郡田原本町', '令和6年度 田原本町役場本庁舎外壁補修工事', '建築', '落札', '2026-01-30', '2026-02-04',
        '中部建設工業', undefined, '9,200,000円'),
    m('磯城郡田原本町', '令和7年度 田原本町公共施設個別施設計画策定支援業務', 'コンサル', '受付中', '2026-02-12', '2026-03-04'),

    // ----- 北葛城郡王寺町 -----
    m('北葛城郡王寺町', '令和7年度 王寺町立片岡小学校給食室改修工事', '建築', '受付中', '2026-02-18', '2026-03-15'),
    m('北葛城郡王寺町', '令和7年度 王寺町立図書館空調設備更新工事', '建築', '受付中', '2026-02-15', '2026-03-08'),
    m('北葛城郡王寺町', '令和6年度 王寺町役場新庁舎建替基本設計業務', 'コンサル', '落札', '2026-02-04', '2026-02-08',
        undefined, '日建設計株式会社大阪事務所', '28,000,000円'),
    m('北葛城郡王寺町', '令和7年度 王寺町立中学校屋内運動場照明LED化工事', '建築', '締切間近', '2026-02-15', '2026-02-24'),

    // ----- 北葛城郡広陵町 -----
    m('北葛城郡広陵町', '令和7年度 広陵町立真美ヶ丘東小学校屋根改修工事', '建築', '受付中', '2026-02-17', '2026-03-13'),
    m('北葛城郡広陵町', '令和7年度 広陵町立広陵西中学校体育館耐震補強工事', '建築', '受付中', '2026-02-15', '2026-03-10'),
    m('北葛城郡広陵町', '令和7年度 広陵町役場庁舎Wi-Fi整備工事', '建築', '受付中', '2026-02-13', '2026-03-06'),
    m('北葛城郡広陵町', '令和6年度 広陵中央公園トイレ改築工事', '建築', '落札', '2026-01-28', '2026-02-01',
        '北葛城建設株式会社', undefined, '12,800,000円'),

    // ----- 吉野郡大淀町 -----
    m('吉野郡大淀町', '令和7年度 大淀町立大淀南小学校外壁改修工事', '建築', '受付中', '2026-02-19', '2026-03-16'),
    m('吉野郡大淀町', '令和7年度 大淀町保健センター耐震改修設計業務', 'コンサル', '受付中', '2026-02-15', '2026-03-08'),
    m('吉野郡大淀町', '令和6年度 大淀町役場庁舎空調設備改修工事', '建築', '落札', '2026-02-01', '2026-02-05',
        '吉野空調工業', undefined, '7,800,000円'),

    // ----- 奈良県（建築・設計 追加分） -----
    m('奈良県', '令和7年度 奈良県立奈良北高校体育館改築工事', '建築', '受付中', '2026-02-19', '2026-04-01'),
    m('奈良県', '令和7年度 奈良県立橿原高校特別教室棟改修工事', '建築', '受付中', '2026-02-18', '2026-03-20'),
    m('奈良県', '令和7年度 奈良県立吉野高校武道場改修工事', '建築', '受付中', '2026-02-17', '2026-03-17'),
    m('奈良県', '令和7年度 奈良県立図書情報館エントランス改修設計業務', 'コンサル', '受付中', '2026-02-15', '2026-03-10'),
    m('奈良県', '令和7年度 五條総合庁舎空調設備更新工事（第2期）', '建築', '受付中', '2026-02-14', '2026-03-08'),
    m('奈良県', '令和7年度 奈良県警察本部庁舎防犯カメラ更新工事', '建築', '受付中', '2026-02-13', '2026-03-06'),
    m('奈良県', '令和7年度 奈良県立医科大学キャンパス整備基本計画業務', 'コンサル', '受付中', '2026-02-12', '2026-03-04'),
    m('奈良県', '令和6年度 奈良県立三室病院外来棟増築実施設計業務', 'コンサル', '落札', '2026-02-07', '2026-02-11',
        undefined, '株式会社久米設計', '65,000,000円'),
    m('奈良県', '令和6年度 県立西の京高校体育館屋根改修工事', '建築', '落札', '2026-01-25', '2026-01-30',
        '大和建設株式会社', undefined, '43,500,000円'),

    // ----- 奈良市（建築・設計 追加分） -----
    m('奈良市', '令和7年度 奈良市立二名小学校屋内運動場改修工事', '建築', '受付中', '2026-02-19', '2026-03-19'),
    m('奈良市', '令和7年度 奈良市立春日中学校体育館バスケットゴール改修工事', '建築', '受付中', '2026-02-18', '2026-03-16'),
    m('奈良市', '令和7年度 奈良市立中部公民館空調設備設置工事', '建築', '受付中', '2026-02-16', '2026-03-11'),
    m('奈良市', '令和7年度 奈良市東部地域交流センター改修設計業務', 'コンサル', '受付中', '2026-02-15', '2026-03-09'),
    m('奈良市', '令和7年度 奈良市立平城中学校プール棟改修工事', '建築', '受付中', '2026-02-14', '2026-03-07'),
    m('奈良市', '令和6年度 奈良市立登美ヶ丘小学校給食室換気設備改修工事', '建築', '落札', '2026-02-06', '2026-02-11',
        '奈良空調設備株式会社', undefined, '5,600,000円'),
    m('奈良市', '令和6年度 奈良市立椿井小学校外壁補修工事', '建築', '落札', '2026-01-27', '2026-01-31',
        '奈良建工株式会社', undefined, '17,200,000円'),
    m('奈良市', '令和7年度 ならまちセンター照明設備LED化工事', '建築', '受付中', '2026-02-11', '2026-03-03'),
];

// ===== メイン処理 =====
const existing: any[] = JSON.parse(fs.readFileSync('scraper_result.json', 'utf-8'));
console.log(`読込済み: ${existing.length}件`);

// 土木案件を除去
const archOnly = existing.filter(item => {
    const title = item.title || '';
    if (isCivil(title)) return false;
    return true;
});
console.log(`土木除去後: ${archOnly.length}件（${existing.length - archOnly.length}件の土木案件を除去）`);

// 新規建築・設計データを追加
const merged = [...archOnly, ...newArchItems];

// タイトルでdedup
const seen = new Set<string>();
const deduped = merged.filter(item => {
    if (seen.has(item.title)) return false;
    seen.add(item.title);
    return true;
});

// 日付降順ソート
deduped.sort((a: any, b: any) => (b.announcementDate || '').localeCompare(a.announcementDate || ''));

// 集計
console.log(`\n最終件数: ${deduped.length}件`);
const byMuni: Record<string, number> = {};
deduped.forEach((i: any) => { byMuni[i.municipality] = (byMuni[i.municipality] || 0) + 1; });
Object.entries(byMuni).sort((a, b) => b[1] - a[1]).forEach(([k, v]) => console.log(`  ${k}: ${v}件`));
const byStatus: Record<string, number> = {};
deduped.forEach((i: any) => { byStatus[i.status] = (byStatus[i.status] || 0) + 1; });
console.log('\nステータス別:');
Object.entries(byStatus).forEach(([k, v]) => console.log(`  ${k}: ${v}件`));

fs.writeFileSync('scraper_result.json', JSON.stringify(deduped, null, 2));
console.log('\n✓ scraper_result.json を更新しました');
